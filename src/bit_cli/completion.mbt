///| Shell completion script generator for bit CLI

///|
async fn handle_completion(args : Array[String]) -> Unit {
  if args.length() == 0 {
    eprint_line("usage: bit completion <bash|zsh>")
    @sys.exit(1)
  }
  match args[0] {
    "bash" => print_line(generate_bash_completion())
    "zsh" => print_line(generate_zsh_completion())
    _ => {
      eprint_line(
        "bit completion: unsupported shell '\{args[0]}'. Use 'bash' or 'zsh'.",
      )
      @sys.exit(1)
    }
  }
}

///|
fn generate_bash_completion() -> String {
  let buf = StringBuilder::new()
  let header =
    #|#!/bin/bash
    #|# bit shell completion - generated by 'bit completion bash'
    #|
    #|__bit_commands() {
    #|    local commands="
  buf.write_string(header)
  let cmds = all_subcommands()
  for i, cmd in cmds {
    buf.write_string("        ")
    buf.write_string(cmd.0)
    if i < cmds.length() - 1 {
      buf.write_string("\n")
    }
  }
  let body =
    #|
    #|    "
    #|    COMPREPLY=( $(compgen -W "$commands" -- "$cur") )
    #|}
    #|
    #|__bit_refs() {
    #|    local refs
    #|    refs=$(git for-each-ref --format='%(refname:short)' refs/heads/ refs/tags/ refs/remotes/ 2>/dev/null)
    #|    COMPREPLY=( $(compgen -W "$refs" -- "$cur") )
    #|}
    #|
    #|__bit_heads() {
    #|    local refs
    #|    refs=$(git for-each-ref --format='%(refname:short)' refs/heads/ 2>/dev/null)
    #|    COMPREPLY=( $(compgen -W "$refs" -- "$cur") )
    #|}
    #|
    #|__bit_tags() {
    #|    local refs
    #|    refs=$(git for-each-ref --format='%(refname:short)' refs/tags/ 2>/dev/null)
    #|    COMPREPLY=( $(compgen -W "$refs" -- "$cur") )
    #|}
    #|
    #|__bit_remotes() {
    #|    local remotes
    #|    remotes=$(git remote 2>/dev/null)
    #|    COMPREPLY=( $(compgen -W "$remotes" -- "$cur") )
    #|}
    #|
    #|_bit() {
    #|    local cur prev words cword
    #|    _init_completion || return
    #|
    #|    # Find the subcommand
    #|    local subcmd=""
    #|    local subcmd_idx=0
    #|    local i
    #|    for ((i=1; i < cword; i++)); do
    #|        case "${words[i]}" in
    #|            -C|-c)
    #|                ((i++))
    #|                ;;
    #|            -*)
    #|                ;;
    #|            *)
    #|                subcmd="${words[i]}"
    #|                subcmd_idx=$i
    #|                break
    #|                ;;
    #|        esac
    #|    done
    #|
    #|    # Global options
    #|    if [[ -z "$subcmd" ]]; then
    #|        if [[ "$cur" == -* ]]; then
    #|            COMPREPLY=( $(compgen -W "-C -c --bare --version --help -h" -- "$cur") )
    #|            return
    #|        fi
    #|        __bit_commands
    #|        return
    #|    fi
    #|
    #|    # Per-command completions
    #|    case "$subcmd" in
    #|        checkout|switch)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-b -B --detach --force -f --merge --quiet -q --track -t --no-track" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        branch)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-d -D --delete -m -M --move -c -C --copy -l --list -a --all -r --remotes --show-current --set-upstream-to --unset-upstream -v --verbose --merged --no-merged --sort --contains --no-contains" -- "$cur") )
    #|            else
    #|                __bit_heads
    #|            fi
    #|            ;;
    #|        merge)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--no-commit --squash --no-ff --ff-only --ff --edit --no-edit --stat --no-stat --log --no-log --strategy -s --strategy-option -X --abort --continue --quit --allow-unrelated-histories -m" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        rebase)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--onto --abort --continue --skip --quit --interactive -i --keep-empty --no-keep-empty --rebase-merges --no-rebase-merges --stat --no-stat" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        cherry-pick)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--edit -e --no-commit -n --mainline -m --abort --continue --quit --skip" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        reset)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--soft --mixed --hard --merge --keep -q --quiet" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        log)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--oneline --graph --all --stat --patch -p --format --pretty --abbrev-commit --no-abbrev-commit --decorate --no-decorate -n --max-count --since --until --after --before --author --grep --first-parent --merges --no-merges --reverse --topo-order --date-order" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        diff)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--stat --numstat --shortstat --name-only --name-status --cached --staged --no-index --patch -p --raw --diff-filter --find-renames -M --find-copies -C --word-diff --color --no-color -U --unified" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        show)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--stat --format --pretty --oneline --patch -p --raw --name-only --name-status --abbrev-commit --no-abbrev-commit" -- "$cur") )
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        add)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-A --all -u --update -n --dry-run -v --verbose -f --force -p --patch --intent-to-add -N" -- "$cur") )
    #|            else
    #|                COMPREPLY=()
    #|            fi
    #|            ;;
    #|        commit)
    #|            COMPREPLY=( $(compgen -W "-m --message -a --all --amend --no-edit -e --edit --allow-empty --allow-empty-message --author --date -s --signoff --dry-run -v --verbose" -- "$cur") )
    #|            ;;
    #|        status)
    #|            COMPREPLY=( $(compgen -W "-s --short -b --branch --porcelain --long -u --untracked-files --ignored -z" -- "$cur") )
    #|            ;;
    #|        push)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--all --tags --force -f --delete --prune -u --set-upstream --dry-run -n --verbose -v --no-verify" -- "$cur") )
    #|            elif [[ "$prev" == "push" ]]; then
    #|                __bit_remotes
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        pull)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--rebase --no-rebase --ff --no-ff --ff-only --stat --no-stat --squash --no-squash --all --tags --prune -v --verbose -q --quiet" -- "$cur") )
    #|            elif [[ "$prev" == "pull" ]]; then
    #|                __bit_remotes
    #|            else
    #|                __bit_refs
    #|            fi
    #|            ;;
    #|        fetch)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--all --tags --prune -f --force --depth --shallow-since --shallow-exclude --dry-run -v --verbose -q --quiet" -- "$cur") )
    #|            else
    #|                __bit_remotes
    #|            fi
    #|            ;;
    #|        remote)
    #|            if ((cword == subcmd_idx + 1)); then
    #|                COMPREPLY=( $(compgen -W "add remove rename set-url get-url show prune -v" -- "$cur") )
    #|            else
    #|                __bit_remotes
    #|            fi
    #|            ;;
    #|        stash)
    #|            if ((cword == subcmd_idx + 1)); then
    #|                COMPREPLY=( $(compgen -W "push pop apply drop list show clear create" -- "$cur") )
    #|            fi
    #|            ;;
    #|        tag)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-a --annotate -d --delete -l --list -f --force -m --message -v --verify -n --sort --contains --no-contains --merged --no-merged --points-at" -- "$cur") )
    #|            else
    #|                __bit_tags
    #|            fi
    #|            ;;
    #|        rm)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-f --force -n --dry-run -r --cached --quiet -q" -- "$cur") )
    #|            else
    #|                COMPREPLY=()
    #|            fi
    #|            ;;
    #|        mv)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "-f --force -n --dry-run -v --verbose -k" -- "$cur") )
    #|            else
    #|                COMPREPLY=()
    #|            fi
    #|            ;;
    #|        config)
    #|            if [[ "$cur" == -* ]]; then
    #|                COMPREPLY=( $(compgen -W "--global --system --local --file --list -l --get --get-all --unset --unset-all -e --edit --add --replace-all" -- "$cur") )
    #|            fi
    #|            ;;
    #|        clone)
    #|            COMPREPLY=( $(compgen -W "--bare --mirror --depth --single-branch --no-single-branch --branch -b --recursive --recurse-submodules --shallow-submodules --no-tags --filter --sparse --quiet -q --verbose -v" -- "$cur") )
    #|            ;;
    #|        init)
    #|            COMPREPLY=( $(compgen -W "--bare --template --separate-git-dir --initial-branch -b --shared --quiet -q" -- "$cur") )
    #|            ;;
    #|        workspace|ws)
    #|            if ((cword == subcmd_idx + 1)); then
    #|                COMPREPLY=( $(compgen -W "init status commit push run export doctor help" -- "$cur") )
    #|            else
    #|                local ws_subcmd="${words[subcmd_idx + 1]}"
    #|                case "$ws_subcmd" in
    #|                    commit)
    #|                        COMPREPLY=( $(compgen -W "-m --message --allow-empty" -- "$cur") )
    #|                        ;;
    #|                    push)
    #|                        COMPREPLY=( $(compgen -W "--resume" -- "$cur") )
    #|                        ;;
    #|                    run)
    #|                        COMPREPLY=( $(compgen -W "--affected" -- "$cur") )
    #|                        ;;
    #|                    export)
    #|                        COMPREPLY=( $(compgen -W "--format" -- "$cur") )
    #|                        ;;
    #|                    *)
    #|                        COMPREPLY=()
    #|                        ;;
    #|                esac
    #|            fi
    #|            ;;
    #|        repo)
    #|            if ((cword == subcmd_idx + 1)); then
    #|                __bit_commands
    #|            else
    #|                COMPREPLY=()
    #|            fi
    #|            ;;
    #|        clean)
    #|            COMPREPLY=( $(compgen -W "-d -f --force -n --dry-run -q --quiet -x -X -e --exclude" -- "$cur") )
    #|            ;;
    #|        completion)
    #|            COMPREPLY=( $(compgen -W "bash zsh" -- "$cur") )
    #|            ;;
    #|        help)
    #|            __bit_commands
    #|            ;;
    #|        *)
    #|            COMPREPLY=()
    #|            ;;
    #|    esac
    #|}
    #|
    #|complete -o bashdefault -o default -F _bit bit
  buf.write_string(body)
  buf.to_string()
}

///|
fn generate_zsh_completion() -> String {
  let buf = StringBuilder::new()
  let header =
    #|#compdef bit
    #|# bit shell completion - generated by 'bit completion zsh'
    #|
    #|__bit_branch_names() {
    #|    local -a branches
    #|    branches=(${(f)"$(git for-each-ref --format='%(refname:short)' refs/heads/ 2>/dev/null)"})
    #|    _describe -t branches 'branch' branches
    #|}
    #|
    #|__bit_tag_names() {
    #|    local -a tags
    #|    tags=(${(f)"$(git for-each-ref --format='%(refname:short)' refs/tags/ 2>/dev/null)"})
    #|    _describe -t tags 'tag' tags
    #|}
    #|
    #|__bit_ref_names() {
    #|    local -a refs
    #|    refs=(${(f)"$(git for-each-ref --format='%(refname:short)' refs/heads/ refs/tags/ refs/remotes/ 2>/dev/null)"})
    #|    _describe -t refs 'ref' refs
    #|}
    #|
    #|__bit_remote_names() {
    #|    local -a remotes
    #|    remotes=(${(f)"$(git remote 2>/dev/null)"})
    #|    _describe -t remotes 'remote' remotes
    #|}
    #|
    #|__bit_commands() {
    #|    local -a commands
    #|    commands=(
  buf.write_string(header)
  let cmds = all_subcommands()
  for cmd in cmds {
    let desc = cmd.1.replace_all(old="'", new="\\'")
    buf.write_string("        '")
    buf.write_string(cmd.0)
    buf.write_string(":")
    buf.write_string(desc)
    buf.write_string("'\n")
  }
  let footer =
    #|    )
    #|    _describe -t commands 'bit command' commands
    #|}
    #|
    #|_bit() {
    #|    local curcontext="$curcontext" state line
    #|    typeset -A opt_args
    #|
    #|    _arguments -C \
    #|        '-C[change directory]:directory:_directories' \
    #|        '-c[set config]:config' \
    #|        '--bare[treat as bare repository]' \
    #|        '(-h --help)'{-h,--help}'[show help]' \
    #|        '(--version -v)--version[show version]' \
    #|        '1:command:__bit_commands' \
    #|        '*::arg:->args'
    #|
    #|    case $state in
    #|    args)
    #|        case $line[1] in
    #|        checkout|switch)
    #|            _arguments \
    #|                '-b[create and checkout new branch]:branch name' \
    #|                '-B[create/reset and checkout branch]:branch name' \
    #|                '--detach[detach HEAD]' \
    #|                '(-f --force)'{-f,--force}'[force checkout]' \
    #|                '--merge[merge local modifications]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '(-t --track)'{-t,--track}'[set up tracking]' \
    #|                '--no-track[do not set up tracking]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        branch)
    #|            _arguments \
    #|                '(-d --delete)'{-d,--delete}'[delete branch]' \
    #|                '-D[force delete branch]' \
    #|                '(-m --move)'{-m,--move}'[rename branch]' \
    #|                '-M[force rename branch]' \
    #|                '(-l --list)'{-l,--list}'[list branches]' \
    #|                '(-a --all)'{-a,--all}'[list all branches]' \
    #|                '(-r --remotes)'{-r,--remotes}'[list remote branches]' \
    #|                '--show-current[show current branch]' \
    #|                '--set-upstream-to=[set upstream]:ref:__bit_ref_names' \
    #|                '--unset-upstream[unset upstream]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '--merged[list merged branches]:ref:__bit_ref_names' \
    #|                '--no-merged[list unmerged branches]:ref:__bit_ref_names' \
    #|                '--sort=[sort]:key' \
    #|                '*:branch:__bit_branch_names'
    #|            ;;
    #|        merge)
    #|            _arguments \
    #|                '--no-commit[do not commit]' \
    #|                '--squash[squash commits]' \
    #|                '--no-ff[create merge commit]' \
    #|                '--ff-only[fast-forward only]' \
    #|                '--ff[fast-forward if possible]' \
    #|                '--edit[edit merge message]' \
    #|                '--no-edit[accept auto merge message]' \
    #|                '--stat[show diffstat]' \
    #|                '--no-stat[hide diffstat]' \
    #|                '--abort[abort merge]' \
    #|                '--continue[continue merge]' \
    #|                '--quit[quit merge]' \
    #|                '--allow-unrelated-histories[allow unrelated histories]' \
    #|                '-m[merge message]:message' \
    #|                '(-s --strategy)'{-s,--strategy}'[merge strategy]:strategy' \
    #|                '-X[strategy option]:option' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        rebase)
    #|            _arguments \
    #|                '--onto[rebase onto]:ref:__bit_ref_names' \
    #|                '--abort[abort rebase]' \
    #|                '--continue[continue rebase]' \
    #|                '--skip[skip current patch]' \
    #|                '--quit[quit rebase]' \
    #|                '(-i --interactive)'{-i,--interactive}'[interactive rebase]' \
    #|                '--keep-empty[keep empty commits]' \
    #|                '--rebase-merges[rebase merge commits]' \
    #|                '--stat[show diffstat]' \
    #|                '--no-stat[hide diffstat]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        cherry-pick)
    #|            _arguments \
    #|                '(-e --edit)'{-e,--edit}'[edit message]' \
    #|                '(-n --no-commit)'{-n,--no-commit}'[do not commit]' \
    #|                '(-m --mainline)'{-m,--mainline}'[mainline parent]:number' \
    #|                '--abort[abort cherry-pick]' \
    #|                '--continue[continue cherry-pick]' \
    #|                '--quit[quit cherry-pick]' \
    #|                '--skip[skip current commit]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        reset)
    #|            _arguments \
    #|                '--soft[soft reset]' \
    #|                '--mixed[mixed reset]' \
    #|                '--hard[hard reset]' \
    #|                '--merge[merge reset]' \
    #|                '--keep[keep reset]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        log)
    #|            _arguments \
    #|                '--oneline[one line per commit]' \
    #|                '--graph[show graph]' \
    #|                '--all[show all refs]' \
    #|                '--stat[show diffstat]' \
    #|                '(-p --patch)'{-p,--patch}'[show patch]' \
    #|                '--format=[format]:format' \
    #|                '--pretty=[pretty format]:format' \
    #|                '--abbrev-commit[abbreviate commit]' \
    #|                '--decorate[show decorations]' \
    #|                '--no-decorate[hide decorations]' \
    #|                '(-n --max-count)'{-n,--max-count}'[limit count]:number' \
    #|                '--since=[since date]:date' \
    #|                '--until=[until date]:date' \
    #|                '--author=[author pattern]:pattern' \
    #|                '--grep=[grep pattern]:pattern' \
    #|                '--first-parent[follow first parent only]' \
    #|                '--merges[show only merges]' \
    #|                '--no-merges[hide merges]' \
    #|                '--reverse[reverse order]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        diff)
    #|            _arguments \
    #|                '--stat[show diffstat]' \
    #|                '--numstat[show numeric diffstat]' \
    #|                '--name-only[show names only]' \
    #|                '--name-status[show name and status]' \
    #|                '--cached[show staged changes]' \
    #|                '--staged[show staged changes]' \
    #|                '--no-index[compare files outside repo]' \
    #|                '(-p --patch)'{-p,--patch}'[show patch]' \
    #|                '--raw[show raw diff]' \
    #|                '--diff-filter=[filter]:filter' \
    #|                '(-M --find-renames)'{-M,--find-renames}'[detect renames]' \
    #|                '(-C --find-copies)'{-C,--find-copies}'[detect copies]' \
    #|                '--word-diff[show word diff]' \
    #|                '--color[show color]' \
    #|                '--no-color[no color]' \
    #|                '(-U --unified)'{-U,--unified}'[context lines]:lines' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        show)
    #|            _arguments \
    #|                '--stat[show diffstat]' \
    #|                '--format=[format]:format' \
    #|                '--pretty=[pretty format]:format' \
    #|                '--oneline[one line]' \
    #|                '(-p --patch)'{-p,--patch}'[show patch]' \
    #|                '--raw[show raw]' \
    #|                '--name-only[names only]' \
    #|                '--name-status[name and status]' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        add)
    #|            _arguments \
    #|                '(-A --all)'{-A,--all}'[add all files]' \
    #|                '(-u --update)'{-u,--update}'[update tracked files]' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '(-f --force)'{-f,--force}'[force add]' \
    #|                '(-p --patch)'{-p,--patch}'[interactive patch]' \
    #|                '(-N --intent-to-add)'{-N,--intent-to-add}'[intent to add]' \
    #|                '*:file:_files'
    #|            ;;
    #|        commit)
    #|            _arguments \
    #|                '(-m --message)'{-m,--message}'[commit message]:message' \
    #|                '(-a --all)'{-a,--all}'[commit all modified]' \
    #|                '--amend[amend last commit]' \
    #|                '--no-edit[use existing message]' \
    #|                '(-e --edit)'{-e,--edit}'[edit message]' \
    #|                '--allow-empty[allow empty commit]' \
    #|                '--allow-empty-message[allow empty message]' \
    #|                '--author=[author]:author' \
    #|                '--date=[date]:date' \
    #|                '(-s --signoff)'{-s,--signoff}'[add Signed-off-by]' \
    #|                '--dry-run[dry run]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '*:file:_files'
    #|            ;;
    #|        status)
    #|            _arguments \
    #|                '(-s --short)'{-s,--short}'[short format]' \
    #|                '(-b --branch)'{-b,--branch}'[show branch info]' \
    #|                '--porcelain[machine format]' \
    #|                '--long[long format]' \
    #|                '(-u --untracked-files)'{-u,--untracked-files}'[show untracked]' \
    #|                '--ignored[show ignored]' \
    #|                '-z[NUL terminated]' \
    #|                '*:file:_files'
    #|            ;;
    #|        push)
    #|            _arguments \
    #|                '--all[push all branches]' \
    #|                '--tags[push tags]' \
    #|                '(-f --force)'{-f,--force}'[force push]' \
    #|                '--delete[delete remote branch]' \
    #|                '--prune[prune remote branches]' \
    #|                '(-u --set-upstream)'{-u,--set-upstream}'[set upstream]' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '--no-verify[skip pre-push hook]' \
    #|                '1:remote:__bit_remote_names' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        pull)
    #|            _arguments \
    #|                '--rebase[rebase on pull]' \
    #|                '--no-rebase[merge on pull]' \
    #|                '--ff[fast-forward if possible]' \
    #|                '--no-ff[create merge commit]' \
    #|                '--ff-only[fast-forward only]' \
    #|                '--squash[squash commits]' \
    #|                '--all[fetch all remotes]' \
    #|                '--tags[fetch tags]' \
    #|                '--prune[prune remote branches]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '1:remote:__bit_remote_names' \
    #|                '*:ref:__bit_ref_names'
    #|            ;;
    #|        fetch)
    #|            _arguments \
    #|                '--all[fetch all remotes]' \
    #|                '--tags[fetch tags]' \
    #|                '--prune[prune deleted refs]' \
    #|                '(-f --force)'{-f,--force}'[force update]' \
    #|                '--depth=[depth]:depth' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '1:remote:__bit_remote_names' \
    #|                '*:refspec'
    #|            ;;
    #|        remote)
    #|            local -a remote_subcmds
    #|            remote_subcmds=(
    #|                'add:add a remote'
    #|                'remove:remove a remote'
    #|                'rename:rename a remote'
    #|                'set-url:set remote URL'
    #|                'get-url:get remote URL'
    #|                'show:show remote info'
    #|                'prune:prune stale refs'
    #|            )
    #|            if ((CURRENT == 2)); then
    #|                _describe -t remote-subcmds 'remote command' remote_subcmds
    #|            else
    #|                __bit_remote_names
    #|            fi
    #|            ;;
    #|        stash)
    #|            local -a stash_subcmds
    #|            stash_subcmds=(
    #|                'push:save changes'
    #|                'pop:apply and remove'
    #|                'apply:apply stash'
    #|                'drop:remove stash'
    #|                'list:list stashes'
    #|                'show:show stash diff'
    #|                'clear:remove all stashes'
    #|                'create:create stash object'
    #|            )
    #|            if ((CURRENT == 2)); then
    #|                _describe -t stash-subcmds 'stash command' stash_subcmds
    #|            fi
    #|            ;;
    #|        tag)
    #|            _arguments \
    #|                '(-a --annotate)'{-a,--annotate}'[annotated tag]' \
    #|                '(-d --delete)'{-d,--delete}'[delete tag]' \
    #|                '(-l --list)'{-l,--list}'[list tags]' \
    #|                '(-f --force)'{-f,--force}'[force]' \
    #|                '(-m --message)'{-m,--message}'[tag message]:message' \
    #|                '(-v --verify)'{-v,--verify}'[verify tag]' \
    #|                '--sort=[sort]:key' \
    #|                '*:tag:__bit_tag_names'
    #|            ;;
    #|        rm)
    #|            _arguments \
    #|                '(-f --force)'{-f,--force}'[force removal]' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '-r[recursive]' \
    #|                '--cached[only remove from index]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '*:file:_files'
    #|            ;;
    #|        mv)
    #|            _arguments \
    #|                '(-f --force)'{-f,--force}'[force move]' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '-k[skip errors]' \
    #|                '*:file:_files'
    #|            ;;
    #|        config)
    #|            _arguments \
    #|                '--global[use global config]' \
    #|                '--system[use system config]' \
    #|                '--local[use local config]' \
    #|                '--file=[config file]:file:_files' \
    #|                '(-l --list)'{-l,--list}'[list all]' \
    #|                '--get[get value]:key' \
    #|                '--get-all[get all values]:key' \
    #|                '--unset[unset value]:key' \
    #|                '(-e --edit)'{-e,--edit}'[edit config]' \
    #|                '--add[add value]:key' \
    #|                '*:key'
    #|            ;;
    #|        clone)
    #|            _arguments \
    #|                '--bare[create bare repo]' \
    #|                '--mirror[mirror repo]' \
    #|                '--depth=[depth]:depth' \
    #|                '--single-branch[single branch]' \
    #|                '(-b --branch)'{-b,--branch}'[checkout branch]:branch' \
    #|                '--recursive[clone submodules]' \
    #|                '--recurse-submodules[clone submodules]' \
    #|                '--no-tags[do not fetch tags]' \
    #|                '--filter=[partial clone filter]:filter' \
    #|                '--sparse[enable sparse checkout]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '(-v --verbose)'{-v,--verbose}'[verbose]' \
    #|                '1:url' \
    #|                '2:directory:_directories'
    #|            ;;
    #|        init)
    #|            _arguments \
    #|                '--bare[create bare repo]' \
    #|                '--template=[template dir]:directory:_directories' \
    #|                '--separate-git-dir=[git dir]:directory:_directories' \
    #|                '(-b --initial-branch)'{-b,--initial-branch}'[initial branch]:name' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '1:directory:_directories'
    #|            ;;
    #|        workspace|ws)
    #|            if ((CURRENT == 2)); then
    #|                _arguments '1:workspace-command:(init status commit push run export doctor help)'
    #|            else
    #|                case $line[2] in
    #|                commit)
    #|                    _arguments \
    #|                        '(-m --message)'{-m,--message}'[commit message]:message' \
    #|                        '--allow-empty[allow empty commit]'
    #|                    ;;
    #|                push)
    #|                    _arguments '--resume=[resume transaction id]:txn-id'
    #|                    ;;
    #|                run)
    #|                    _arguments '--affected[run only affected closure]' '1:task'
    #|                    ;;
    #|                export)
    #|                    _arguments '--format=[export format]:format:(git-interop)'
    #|                    ;;
    #|                *)
    #|                    _files
    #|                    ;;
    #|                esac
    #|            fi
    #|            ;;
    #|        repo)
    #|            if ((CURRENT == 2)); then
    #|                __bit_commands
    #|            else
    #|                _files
    #|            fi
    #|            ;;
    #|        clean)
    #|            _arguments \
    #|                '-d[remove directories]' \
    #|                '(-f --force)'{-f,--force}'[force]' \
    #|                '(-n --dry-run)'{-n,--dry-run}'[dry run]' \
    #|                '(-q --quiet)'{-q,--quiet}'[quiet]' \
    #|                '-x[remove ignored files too]' \
    #|                '-X[remove only ignored files]' \
    #|                '(-e --exclude)'{-e,--exclude}'[exclude pattern]:pattern' \
    #|                '*:file:_files'
    #|            ;;
    #|        completion)
    #|            _arguments '1:shell:(bash zsh)'
    #|            ;;
    #|        help)
    #|            __bit_commands
    #|            ;;
    #|        *)
    #|            _files
    #|            ;;
    #|        esac
    #|        ;;
    #|    esac
    #|}
    #|
    #|_bit "$@"
  buf.write_string(footer)
  buf.to_string()
}

///|
fn all_subcommands() -> Array[(String, String)] {
  [
    ("add", "Add file contents to the index"),
    ("am", "Apply patches from a mailbox"),
    ("apply", "Apply a patch to files and/or to the index"),
    ("bisect", "Find by binary search the change that introduced a bug"),
    ("blame", "Show what revision and author last modified each line"),
    ("branch", "List, create, or delete branches"),
    ("bundle", "Create, verify, list-heads, and unbundle Git bundles"),
    ("cat", "Show file contents from a remote repository"),
    ("cat-file", "Provide content or type info for repository objects"),
    ("checkout", "Switch branches or restore working tree files"),
    ("cherry", "Find commits yet to be applied to upstream"),
    ("cherry-pick", "Apply the changes from existing commits"),
    ("clean", "Remove untracked files from the working tree"),
    ("clone", "Clone a repository into a new directory"),
    ("hub", "Manage pull requests and issues"),
    ("commit", "Record changes to the repository"),
    ("completion", "Generate shell completion scripts"),
    ("config", "Get and set repository options"),
    ("describe", "Give an object a human readable name based on a ref"),
    ("diff", "Show changes between commits, commit and working tree, etc"),
    ("fetch", "Download objects and refs from another repository"),
    ("format-patch", "Prepare patches for e-mail submission"),
    ("fsck", "Verify the connectivity and validity of objects"),
    ("gc", "Cleanup unnecessary files and optimize the local repository"),
    ("grep", "Print lines matching a pattern"),
    ("hash-object", "Compute object ID and optionally creates a blob"),
    ("help", "Show help information"),
    ("hq", "ghq-compatible repository management"),
    ("index-pack", "Build pack index file for an existing packed archive"),
    ("init", "Create an empty Git repository"),
    ("log", "Show commit logs"),
    ("ls-files", "Show information about files in the index"),
    ("ls-tree", "List the contents of a tree object"),
    ("maintenance", "Run tasks to optimize Git repository data"),
    ("mcp", "Run bit MCP server (stdio)"),
    ("merge", "Join two or more development histories together"),
    ("mktree", "Build a tree-object from ls-tree formatted text"),
    ("multi-pack-index", "Write and verify multi-pack-indexes"),
    ("mv", "Move or rename a file, a directory, or a symlink"),
    ("notes", "Add or inspect object notes"),
    ("pack-objects", "Create a packed archive of objects"),
    ("pack-refs", "Pack heads and tags for efficient repository access"),
    ("prune", "Prune all unreachable objects from the object database"),
    ("pull", "Fetch from and integrate with another repository"),
    ("push", "Update remote refs along with associated objects"),
    ("range-diff", "Compare two commit ranges"),
    ("read-tree", "Read tree information into the index"),
    ("repo", "Run regular bit command without workspace translation"),
    ("rebase", "Reapply commits on top of another base tip"),
    ("receive-pack", "Receive what is pushed into the repository"),
    ("reflog", "Manage reflog information"),
    ("remote", "Manage set of tracked repositories"),
    ("repack", "Pack unpacked objects in a repository"),
    ("request-pull", "Generate a summary of pending changes"),
    ("reset", "Reset current HEAD to the specified state"),
    ("rev-list", "List commit objects in reverse chronological order"),
    ("rev-parse", "Parse revision specifications"),
    ("revert", "Revert some existing commits"),
    ("rm", "Remove files from the working tree and from the index"),
    ("send-pack", "Push objects over git protocol to another repository"),
    ("shortlog", "Summarize git log output"),
    ("show", "Show various types of objects"),
    ("show-branch", "Show branches and their commits"),
    ("show-ref", "List references in a local repository"),
    ("sparse-checkout", "Initialize and modify the sparse-checkout config"),
    ("stash", "Stash the changes in a dirty working directory"),
    ("status", "Show the working tree status"),
    ("subdir-clone", "Clone subdirectory as independent repository"),
    ("submodule", "Initialize, update or inspect submodules"),
    ("switch", "Switch branches"),
    ("symbolic-ref", "Read, modify and delete symbolic refs"),
    ("tag", "Create, list, delete tag objects"),
    ("tree", "List tree entries from a remote repository"),
    ("unpack-objects", "Unpack objects from a packed archive"),
    ("update-index", "Register file contents in the index"),
    ("update-ref", "Update the object name stored in a ref safely"),
    ("upload-pack", "Send objects packed back to git-fetch-pack"),
    ("verify-pack", "Validate packed Git archive files"),
    ("worktree", "Manage multiple working trees"),
    ("workspace", "Manage hierarchical bit workspace projects"),
    ("ws", "Shortcut for workspace"),
    ("write-tree", "Create a tree object from the current index"),
  ]
}
