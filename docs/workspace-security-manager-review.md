# Workspace レビュー（セキュリティ / 大規模運用）

`bit workspace` の現仕様を、以下2観点でレビューした記録です。

- セキュリティ
- 大規模プロジェクトの運用管理

## セキュリティ観点

### 想定した脅威

- manifest のパス脱出（`../` や workspace 外絶対パス）
- 信頼できない manifest による workspace 外コマンド実行
- workspace 実行後の `git` と `bit repo` の整合崩れ

### 現在の対策

- 実行前バリデーションで workspace 外パスを拒否。
- 実行前バリデーションで依存グラフ不整合（未知依存・循環・重複ID）を拒否。
- バリデーション失敗時に、リポジトリ HEAD が変更されないことを E2E で検証。
- 拒否後も `git status --porcelain` と `bit repo status --porcelain` の整合を検証。

### 残課題

- `task.*` は `sh -lc` 実行のため、設計上「信頼済み設定」を前提にする必要がある。
- パス検証は字面ベースで、シンボリックリンク経由の脱出対策は未完了。

## 大規模運用観点

### 想定した運用課題

- 依存グラフガバナンス（未知依存・循環・重複ID）
- required/optional ノードの失敗ポリシー
- 変更を伴う処理の fail-fast 性
- 実行監査性（誰がどこで失敗したか）

### 現在の対策

- バリデーションで未知依存・循環・重複IDを拒否。
- optional ノード失敗時、required ノードが成功していれば flow 全体は成功扱いにできる。
- `.git/txns/*.json` を監査ログとして保持。

### 今後の拡張候補

- 大規模グラフ向けの分散/並列スケジューリング
- キャッシュキーへの環境・ツールチェーン指紋の追加
- 承認フローや信頼境界を含むポリシーレイヤ

## 関連テスト

- `t/t9012-workspace-security-boundary.sh`
- `t/t9013-workspace-manager-review.sh`
